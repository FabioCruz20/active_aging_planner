{% extends 'layout.html' %}

{% block content %}
<div class="container mx-auto">
    <div class="mt-2 mb-4">
        <h1 class="font-bold text-2xl">{{ project.name }} - Matriz de Ações</h1>
        <a href="{% url 'projects:list' %}" class="text-sm text-blue-500">Voltar para Projetos</a>
    </div>

    <div class="mb-6">
        {% csrf_token %}
        
        <div class="overflow-x-auto">
            <table class="w-full border-collapse border border-gray-300">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border border-gray-300 p-3 text-left font-semibold">Eixo Temático / Nível</th>
                        {% for level in levels %}
                        <th class="border border-gray-300 p-3 text-center font-semibold min-w-48">
                            Nível {{ level.level_number }}<br>
                            <span class="text-sm font-normal">{{ level.name }}</span>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for axis, level_data in matrix.items %}
                    <tr class="{% cycle 'bg-white' 'bg-gray-50' %}">
                        <td class="border border-gray-300 p-3 font-medium bg-gray-100">
                            {{ axis.name }}
                        </td>
                        {% for level in levels %}
                        <td class="border border-gray-300 p-3 text-center">
                            {% for level_key, cell_data in level_data.items %}
                                {% if level_key == level %}
                                    <!-- Link para gerenciar ações -->
                                    <div class="mb-3">
                                        <a href="{% url 'projects:manage_axis_level_actions' project.id axis.id level.id %}" 
                                           class="inline-block px-3 py-2 bg-indigo-500 text-white text-sm rounded hover:bg-indigo-700 transition-colors">
                                            <i class="fas fa-cog"></i> Gerenciar Ações
                                        </a>
                                        <div class="mt-1 text-xs text-gray-600">
                                            {{ cell_data.actions.count }} ação{{ cell_data.actions.count|pluralize:"es" }}
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <div class="text-sm">
                                            <div class="font-medium">Progresso:</div>
                                            <div class="text-gray-600">
                                                {{ cell_data.progress|floatformat:1 }}%
                                                <span class="text-xs">({{ cell_data.completed_actions }}/{{ cell_data.total_actions }} ações completas)</span>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% empty %}
                                <!-- Link para gerenciar ações quando não há dados -->
                                <div class="mb-3">
                                    <a href="{% url 'projects:manage_axis_level_actions' project.id axis.id level.id %}" 
                                       class="inline-block px-3 py-2 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors">
                                        <i class="fas fa-cog"></i> Gerenciar Ações
                                    </a>
                                    <div class="mt-1 text-xs text-gray-600">
                                        0 ações
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <div class="text-sm">
                                        <div class="font-medium">Progresso:</div>
                                        <div class="text-gray-600">
                                            0%
                                            <span class="text-xs">(0/0 ações completas)</span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-4">
            <a href="{% url 'projects:list' %}" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 inline-block">
                Voltar
            </a>
        </div>
    </div>

    <div class="mt-6 p-4 bg-blue-50 rounded">
        <h3 class="font-semibold mb-2">Como usar esta matriz:</h3>
        <ul class="text-sm text-gray-700 space-y-1">
            <li>• Cada célula representa a combinação de um eixo temático com um nível de maturidade</li>
            <li>• Clique em "Gerenciar Ações" para adicionar, editar ou remover ações para cada combinação eixo/nível</li>
            <li>• O número de ações é exibido abaixo do botão de gerenciamento</li>
            <li>• O progresso é calculado automaticamente com base nas ações que têm todas as suas tarefas concluídas</li>
            <li>• Para aumentar o progresso, complete todas as tarefas de cada ação</li>
        </ul>
    </div>
</div>
{% endblock %}